<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æˆ³æˆ³æ¨‚å¤§å†’éšª - å…’ç«¥æ’ç³»çµ±</title>
    <style>
        :root {
            /* å†’éšªè‰²å½©ï¼šé¦¬å¡é¾è‰²ç³» */
            --color-blue: #E3F2FD;
            --color-green: #E8F5E9;
            --color-yellow: #FFF9C4;
            --color-orange: #FFE0B2;
            --color-purple: #F3E5F5;
            
            --bg-texture: #FDFBF7;
            --text-main: #5D544C;
            --text-light: #A8A096;
            --white: #FFFFFF;
            --accent: #FFAB91;
            
            /* é™°å½±è¨­è¨ˆ */
            --shadow-paper: 0 4px 8px rgba(93, 84, 76, 0.12);
            --shadow-sticker: 0 2px 0px rgba(0, 0, 0, 0.05);
            --shadow-lift: 0 10px 30px rgba(93, 84, 76, 0.2);
            --transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: "PingFang TC", "Microsoft JhengHei", "Rounded Mplus 1c", sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--bg-texture);
            color: var(--text-main);
            min-height: 100vh;
            overflow-y: auto;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            background-image: 
                radial-gradient(circle at 10% 10%, rgba(167, 199, 231, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 90% 90%, rgba(255, 209, 220, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 50% 50%, #E8E1D9 1.5px, transparent 1.5px);
            background-size: 100% 100%, 100% 100%, 40px 40px;
        }

        /* æ¨™é¡Œå€åŸŸ */
        header {
            padding: 15px 10px 10px;
            text-align: center;
            flex-shrink: 0;
            position: relative;
        }

        h1 {
            font-size: clamp(1.6rem, 5vw, 2.5rem);
            color: #7D6E5D;
            letter-spacing: clamp(1px, 0.5vw, 4px);
            cursor: pointer;
            user-select: none;
            text-shadow: 2px 2px 0px rgba(255,255,255,0.9);
        }

        /* ç®¡ç†æŒ‰éˆ• */
        .btn-settings-trigger {
            position: absolute;
            right: 15px;
            top: 15px;
            background: rgba(255,255,255,0.6);
            border: 1px solid white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            font-size: 1rem;
            color: var(--text-light);
            cursor: pointer;
            opacity: 0.5;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        /* æ ¼å­ç‰†ä½ˆå±€ */
        .grid-container {
            flex-grow: 1;
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: clamp(6px, 1.5vw, 12px);
            padding: 5px clamp(10px, 3vw, 30px) 40px;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        @media (max-width: 768px) {
            .grid-container { grid-template-columns: repeat(4, 1fr); }
        }

        @media (max-width: 480px) {
            .grid-container { grid-template-columns: repeat(3, 1fr); }
        }

        body.task-active { overflow: hidden; }

        /* æ ¼å­å¡ç‰‡ */
        .poke-item {
            background: var(--white);
            border-radius: clamp(10px, 2vw, 18px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: var(--shadow-paper);
            cursor: pointer;
            transition: var(--transition);
            border: 3px solid var(--white);
            position: relative;
            aspect-ratio: 1 / 1;
        }

        .poke-item:hover { transform: scale(1.05); }

        .c-1 { background-color: var(--color-blue); }
        .c-2 { background-color: var(--color-green); }
        .c-3 { background-color: var(--color-yellow); }
        .c-4 { background-color: var(--color-orange); }
        .c-5 { background-color: var(--color-purple); }

        .poke-item.completed {
            background-color: #ECEAE7 !important;
            cursor: default;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }

        .number-sticker {
            background: white;
            width: clamp(28px, 10vw, 45px);
            height: clamp(28px, 10vw, 45px);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(0.9rem, 4vw, 1.4rem);
            font-weight: 900;
            color: #7D6E5D;
            box-shadow: var(--shadow-sticker);
            z-index: 5;
            transform: rotate(-4deg);
            margin-top: -5px;
        }

        .char-icon {
            position: absolute;
            bottom: -2%;
            right: -2%;
            width: 75%;
            height: 75%;
            opacity: 0.6;
            z-index: 2;
        }

        /* å½ˆå‡ºå±¤ */
        .view {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 500;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 15px;
            text-align: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .view.active { opacity: 1; pointer-events: auto; }
        .view.hidden { display: none !important; }

        #task-view { background: rgba(253, 251, 247, 0.98); }
        #enc-view { background: rgba(253, 251, 247, 0.98); }

        .card-task {
            background: white;
            padding: clamp(20px, 6vw, 50px);
            border-radius: 30px;
            box-shadow: 0 15px 50px rgba(93, 84, 76, 0.15);
            max-width: 90%;
            width: 100%;
            border: 8px solid rgba(255,255,255,0.8);
            max-height: 85vh;
            overflow-y: auto;
        }

        .task-content {
            font-size: clamp(1.4rem, 6vw, 3rem);
            font-weight: 900;
            margin-bottom: 20px;
            line-height: 1.3;
            color: #4A443F;
        }

        /* é¼“å‹µèªå°ˆç”¨å­—é«” */
        #enc-text {
            font-size: clamp(1.8rem, 8vw, 3.5rem);
            color: #FF8A80;
            margin-bottom: 10px;
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .task-guide {
            font-size: clamp(0.85rem, 3.5vw, 1.3rem);
            color: #8D8276;
            margin-bottom: 30px;
            background: #F9F7F5;
            padding: 12px 20px;
            border-radius: 15px;
            display: inline-block;
            border-left: 5px solid var(--color-green);
        }

        .button-group { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; }

        .btn {
            padding: 12px 25px;
            font-size: clamp(0.95rem, 4vw, 1.3rem);
            font-weight: bold;
            border: none;
            border-radius: 40px;
            cursor: pointer;
            transition: 0.2s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            min-width: 110px;
        }

        .btn-primary { background: linear-gradient(to bottom, #C1E1C1, #9BC49B); color: white; }
        .btn-secondary { background: #F3F0EC; color: #9C948C; }
        .btn-danger { background: #FFAB91; color: white; }

        /* ç®¡ç†æ¨¡å¼è¦–çª— */
        .admin-view { 
            background: #fff; 
            padding: 15px; 
            overflow-y: auto; 
            text-align: left; 
            position: fixed; 
            top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 1000; 
        }

        .admin-container { max-width: 700px; margin: 0 auto; padding-bottom: 40px; }
        
        .admin-section-box {
            background: #FDFBF7; padding: 15px; border-radius: 15px; border: 1.5px dashed #E8E1D9; margin-top: 15px;
        }

        .admin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .admin-header h2 { font-size: 1.3rem; }

        .admin-footer { 
            margin-top: 30px; 
            padding-top: 20px; 
            border-top: 1px solid #eee; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 12px; 
        }

        /* ä¿®æ­£å¾Œçš„åº•éƒ¨æŒ‰éˆ• */
        .btn-save-sm { font-size: 1rem; padding: 10px 25px; width: auto; min-width: 200px; }

        .check-mark {
            position: absolute;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: clamp(2rem, 12vw, 4rem);
            color: rgba(93, 84, 76, 0.15);
            z-index: 0;
            font-weight: 900;
        }

        .svg-lib { display: none; }
        textarea, input[type="text"] { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ddd; border-radius: 10px; font-size: 0.95rem; }
        
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #f9f9f9; font-size: 0.9rem; }
    </style>
</head>
<body>

    <!-- SVG è§’è‰²åº« -->
    <svg class="svg-lib">
        <symbol id="char-lamb-awake" viewBox="0 0 100 100"><circle cx="50" cy="50" r="42" fill="#F4F2EF" /><circle cx="35" cy="45" r="5" fill="#5D544C" /><circle cx="65" cy="45" r="5" fill="#5D544C" /><path d="M42 62 Q50 70 58 62" fill="none" stroke="#5D544C" stroke-width="4" stroke-linecap="round" /><ellipse cx="15" cy="40" rx="10" ry="14" fill="#F4F2EF" /><ellipse cx="85" cy="40" rx="10" ry="14" fill="#F4F2EF" /></symbol>
        <symbol id="char-lamb-sleep" viewBox="0 0 100 100"><circle cx="50" cy="50" r="42" fill="#E0DED9" /><path d="M30 45 Q35 50 40 45" fill="none" stroke="#A8A096" stroke-width="4" stroke-linecap="round" /><path d="M60 45 Q65 50 70 45" fill="none" stroke="#A8A096" stroke-width="4" stroke-linecap="round" /></symbol>
        <symbol id="char-star-awake" viewBox="0 0 100 100"><path d="M50 8 L63 38 L95 38 L70 58 L80 88 L50 72 L20 88 L30 58 L5 38 L37 38 Z" fill="#FFF9C4" /><circle cx="42" cy="48" r="3.5" fill="#5D544C" /><circle cx="58" cy="48" r="3.5" fill="#5D544C" /></symbol>
        <symbol id="char-star-sleep" viewBox="0 0 100 100"><path d="M50 8 L63 38 L95 38 L70 58 L80 88 L50 72 L20 88 L30 58 L5 38 L37 38 Z" fill="#E8E4E0" /><path d="M38 48 Q42 52 46 48" fill="none" stroke="#A8A096" stroke-width="3" /><path d="M54 48 Q58 52 62 48" fill="none" stroke="#A8A096" stroke-width="3" /></symbol>
        <symbol id="char-heart-awake" viewBox="0 0 100 100"><path d="M50 88 L43 81 C25 65 15 53 15 38 C15 25 25 15 38 15 C45 15 52 18 56 25 C60 18 67 15 74 15 C87 15 97 25 97 38 C97 53 87 65 69 81 Z" fill="#FFD1DC" /><circle cx="45" cy="40" r="4" fill="#5D544C" /><circle cx="67" cy="40" r="4" fill="#5D544C" /></symbol>
        <symbol id="char-heart-sleep" viewBox="0 0 100 100"><path d="M50 88 L43 81 C25 65 15 53 15 38 C15 25 25 15 38 15 C45 15 52 18 56 25 C60 18 67 15 74 15 C87 15 97 25 97 38 C97 53 87 65 69 81 Z" fill="#EAE8E5" /><path d="M40 40 Q45 45 50 40" fill="none" stroke="#A8A096" stroke-width="3" /><path d="M62 40 Q67 45 72 40" fill="none" stroke="#A8A096" stroke-width="3" /></symbol>
        <symbol id="char-cloud-awake" viewBox="0 0 100 100"><path d="M25 60 C10 60 10 40 25 40 C25 20 45 20 50 35 C55 20 75 20 75 40 C90 40 90 60 75 60 Z" fill="#E3F2FD" /><circle cx="42" cy="45" r="3" fill="#5D544C" /><circle cx="58" cy="45" r="3" fill="#5D544C" /></symbol>
        <symbol id="char-cloud-sleep" viewBox="0 0 100 100"><path d="M25 60 C10 60 10 40 25 40 C25 20 45 20 50 35 C55 20 75 20 75 40 C90 40 90 60 75 60 Z" fill="#DCE1E6" /><path d="M38 45 Q42 48 46 45" fill="none" stroke="#A8A096" stroke-width="2" /><path d="M54 45 Q58 48 62 45" fill="none" stroke="#A8A096" stroke-width="2" /></symbol>
    </svg>

    <header>
        <h1 id="app-title">ã€ˆæˆ³æˆ³æ¨‚å¤§å†’éšªã€‰</h1>
        <button class="btn-settings-trigger" onclick="requestAdminAccess()">âš™ï¸</button>
    </header>

    <div id="grid-wall" class="grid-container"></div>

    <!-- ä»»å‹™æ­æ›‰è¦–çª— -->
    <div id="task-view" class="view hidden">
        <div class="card-task">
            <div class="task-pre-title">âœ¨ å‹‡æ•¢çš„å†’éšªè€…ï¼Œé€™æ˜¯ä½ çš„å°ä»»å‹™ âœ¨</div>
            <div id="current-task-text" class="task-content">å°‹æ‰¾ä»»å‹™ä¸­...</div>
            <div id="current-task-guide" class="task-guide">è€å¸«æœƒå’Œä½ ä¸€èµ·å®Œæˆé€™å€‹æŒ‘æˆ°å–”ï¼</div>
            <div class="button-group">
                <button class="btn btn-secondary" onclick="cancelTask()">è¿”å›åœ°åœ–</button>
                <button class="btn btn-primary" id="finish-task-btn" onclick="finishTask()">æˆ‘å®Œæˆä»»å‹™äº† âœ“</button>
            </div>
        </div>
    </div>

    <!-- é¼“å‹µèªå°ˆç”¨è¦–çª— (å¾¹åº•ä¿®å¾©é») -->
    <div id="enc-view" class="view hidden">
        <div class="card-task" style="border-color: #F3E5F5; overflow: hidden;">
            <div id="enc-text" class="task-content">åšå¾—å¤ªæ£’äº†ï¼ â¤ï¸</div>
            <div style="margin-top: 15px; font-size: 1.1rem; color: #A8A096;">[ ä»»å‹™é”æˆï¼æ­£åœ¨å›åˆ°å†’éšªç‰† ]</div>
        </div>
    </div>

    <!-- ç®¡ç†è€…ä»‹é¢ -->
    <div id="admin-view" class="view admin-view hidden">
        <div class="admin-container">
            <div class="admin-header">
                <h2>å†’éšªä»»å‹™æ§åˆ¶å°</h2>
                <button onclick="closeAdmin()" class="btn btn-secondary" style="min-width: auto; padding: 5px 15px;">é—œé–‰</button>
            </div>

            <label class="toggle-switch">
                <input type="checkbox" id="audio-toggle" class="toggle-input" onchange="toggleAudio(this.checked)">
                <div class="toggle-slider"></div>
                <span id="audio-status-text" style="font-size: 0.9rem;">éŸ³æ•ˆå·²é–‹å•Ÿ</span>
            </label>

            <div class="admin-section-box">
                <h3>ğŸ“œ æ–°å¢ä»»å‹™å¡</h3>
                <input type="text" id="new-task-title" placeholder="ä¸»è¦å…§å®¹ (å¤§å­—)">
                <input type="text" id="new-task-guide" placeholder="å¼•å°èªªæ˜ (å°å­—)">
                <button onclick="addAdminTask()" class="btn btn-primary" style="width: 100%; padding: 8px;">åŠ å…¥ä»»å‹™åº«</button>
            </div>

            <div class="admin-section-box">
                <h3>ğŸ’– ç·¨è¼¯é¼“å‹µèª (æ¯è¡Œä¸€å¥)</h3>
                <textarea id="admin-enc-textarea" style="height: 100px;"></textarea>
                <button onclick="saveEncConfig()" class="btn btn-primary" style="width: 100%; padding: 8px;">å„²å­˜é¼“å‹µèª</button>
            </div>

            <h3 style="margin: 20px 0 10px; font-size: 1.1rem;">ğŸ“‹ ä»»å‹™ç¸½è¡¨ (<span id="task-count-display">0</span>)</h3>
            <div id="admin-task-list" style="max-height: 200px; overflow-y: auto; border: 1px solid #eee; border-radius: 10px; padding: 5px; background: #fafafa;"></div>

            <div class="admin-footer">
                <button onclick="closeAdmin()" class="btn btn-primary btn-save-sm">å„²å­˜ä¸¦è¿”å›åœ°åœ–</button>
                <div style="display: flex; gap: 8px; width: 100%; max-width: 350px;">
                    <button onclick="resetAllGrids()" class="btn btn-danger" style="flex: 1; font-size: 0.85rem;">é‡ç½®é€²åº¦</button>
                    <button onclick="resetConfig()" class="btn btn-secondary" style="flex: 1; font-size: 0.85rem;">æ¢å¾©åŸå» </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // éŸ³æ•ˆå¼•æ“
        let audioCtx = null;
        function initAudio() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
        function playSound(type) {
            if (!state.audioEnabled || !audioCtx) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const masterGain = audioCtx.createGain(); masterGain.gain.setValueAtTime(0.15, audioCtx.currentTime); masterGain.connect(audioCtx.destination);
            if(type==='tap'){
                const osc = audioCtx.createOscillator(); const g = audioCtx.createGain(); osc.frequency.setValueAtTime(250, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1); osc.connect(g); g.connect(masterGain); osc.start(); osc.stop(audioCtx.currentTime+0.1);
            } else if(type==='shimmer'){
                [880, 1100].forEach((f, i) => { const osc = audioCtx.createOscillator(); osc.frequency.setValueAtTime(f, audioCtx.currentTime + i*0.05); const g = audioCtx.createGain(); g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5); osc.connect(g); g.connect(masterGain); osc.start(audioCtx.currentTime + i*0.05); osc.stop(audioCtx.currentTime+0.5); });
            } else if(type==='success'){
                [523, 659, 783].forEach((f, i) => { const osc = audioCtx.createOscillator(); osc.frequency.setValueAtTime(f, audioCtx.currentTime + i*0.1); const g = audioCtx.createGain(); g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.4); osc.connect(g); g.connect(masterGain); osc.start(audioCtx.currentTime + i*0.1); osc.stop(audioCtx.currentTime+0.5); });
            }
        }

        const initialTasks = [
            { id: "t1", content: "å°å¤§å®¶èªªä¸€æ¬¡ã€Œä¸»è€¶ç©Œæˆ‘æ„›ä½ ã€", guide: "è€å¸«å¯ä»¥å¸¶é ˜å¤§å®¶ä¸€èµ·å›æ‡‰ä»–å–”" },
            { id: "t2", content: "æ‰¾ä¸€ä½å°æœ‹å‹æ“ŠæŒ High-five", guide: "æŠŠå–œæ¨‚åˆ†äº«çµ¦èº«é‚Šçš„æœ‹å‹" },
            { id: "t3", content: "éœ²å‡ºä¸€å€‹æœ€å¤§ã€æœ€æ£’çš„ç¬‘å®¹", guide: "å–œæ¨‚çš„å¿ƒä¹ƒæ˜¯è‰¯è—¥" },
            { id: "t4", content: "å­¸å°ç¾Šå’©å’©å« 3 è²", guide: "æˆ‘å€‘éƒ½æ˜¯ä¸»æ‰€æ„›è­·çš„å°ç¾Š" },
            { id: "t5", content: "å¤§è²å®£ä½ˆï¼šæˆ‘æ˜¯ç¥çš„å¥½å­©å­", guide: "å±•ç¾ç¥å®¶å°ç²¾å…µçš„ç²¾ç¥" },
            { id: "t14", content: "å¤§è²å‘¼æ±‚ï¼šå–”ï¼Œä¸»è€¶ç©Œï¼", guide: "æœ€ç°¡å–®ä¹Ÿæœ€æœ‰èƒ½åŠ›çš„ç”Ÿå‘½æ“ç·´" }
        ];
        const initialEncs = [ "åšå¾—å¤ªæ£’äº†ï¼ â¤ï¸", "ä½ çœŸçš„å¾ˆå¯¶è²´ï¼ŒåŠ æ²¹ï¼", "çœŸæ£’çš„æ“ç·´ï¼", "ä½ æ˜¯æœ€å‹‡æ•¢çš„å°ç²¾å…µï¼", "å¤§å®¶éƒ½å¾ˆç‚ºä½ é–‹å¿ƒï¼" ];

        let state = { tasks: [], encouragements: [], gridProgress: {}, sessionShownTaskIds: [], audioEnabled: true, pin: "1234" };
        let currentActiveIndex = -1;
        const iconTypes = ['lamb', 'star', 'heart', 'cloud'];

        function init() {
            const savedState = localStorage.getItem('poke_fun_adventure_v7');
            if (savedState) {
                state = JSON.parse(savedState);
                if(!state.sessionShownTaskIds) state.sessionShownTaskIds = [];
                if(!state.encouragements || state.encouragements.length === 0) state.encouragements = [...initialEncs];
            } else {
                state.tasks = [...initialTasks]; state.encouragements = [...initialEncs];
                for(let i=1; i<=40; i++) state.gridProgress[i] = false;
                saveState();
            }
            const audioToggle = document.getElementById('audio-toggle');
            if(audioToggle) audioToggle.checked = state.audioEnabled;
            renderGrid(); initAdminEntry();
        }

        function saveState() { localStorage.setItem('poke_fun_adventure_v7', JSON.stringify(state)); }
        function toggleAudio(e) { initAudio(); state.audioEnabled = e; saveState(); }

        function renderGrid() {
            const container = document.getElementById('grid-wall'); container.innerHTML = '';
            for (let i = 1; i <= 40; i++) {
                const item = document.createElement('div');
                const isComp = state.gridProgress[i];
                const cIdx = ((i - 1) % 5) + 1;
                const char = iconTypes[(i - 1) % iconTypes.length];
                const charSt = isComp ? 'sleep' : 'awake';
                item.className = `poke-item c-${cIdx} ${isComp ? 'completed' : ''}`;
                item.innerHTML = `<div class="number-sticker">${i<10?'0'+i:i}</div><svg class="char-icon"><use xlink:href="#char-${char}-${charSt}"></use></svg>${isComp ? '<div class="check-mark">âœ“</div>' : ''}`;
                item.onclick = () => handleGridClick(i, item);
                container.appendChild(item);
            }
        }

        function handleGridClick(idx, el) {
            if (state.gridProgress[idx]) return;
            initAudio(); playSound('tap');
            document.body.classList.add('task-active');
            el.style.transform = "scale(1.2) translateY(-15px)"; el.style.zIndex = "200";
            setTimeout(() => {
                currentActiveIndex = idx;
                let pool = state.tasks.filter(t => !state.sessionShownTaskIds.includes(t.id));
                if (pool.length === 0) { state.sessionShownTaskIds = []; pool = state.tasks; }
                const task = pool[Math.floor(Math.random() * pool.length)];
                state.sessionShownTaskIds.push(task.id); saveState();
                document.getElementById('current-task-text').innerText = task.content;
                document.getElementById('current-task-guide').innerText = task.guide || "è€å¸«æœƒé™ªè‘—ä½ å–”ï¼";
                showView('task-view'); playSound('shimmer');
            }, 300);
        }

        // å¾¹åº•ä¿®å¾©ï¼šç¢ºä¿é¡¯ç¤ºé¼“å‹µèªè¦–çª—
        function finishTask() {
            playSound('success');
            // ç«‹å³å¾ç›®å‰çš„ state ä¸­éš¨æ©Ÿé¸å–ä¸€å¥
            const list = (state.encouragements && state.encouragements.length > 0) ? state.encouragements : initialEncs;
            const msg = list[Math.floor(Math.random() * list.length)];
            
            // æ³¨å…¥æ–‡å­—ä¸¦é¡¯ç¤ºç•«é¢
            document.getElementById('enc-text').innerText = msg;
            showView('enc-view'); 
            
            state.gridProgress[currentActiveIndex] = true; 
            saveState();
            
            setTimeout(() => { 
                document.body.classList.remove('task-active'); 
                showView('grid-wall'); 
                renderGrid(); 
            }, 2200);
        }

        function cancelTask() { state.sessionShownTaskIds.pop(); saveState(); document.body.classList.remove('task-active'); showView('grid-wall'); renderGrid(); currentActiveIndex = -1; }
        
        function showView(viewId) { 
            document.querySelectorAll('.view').forEach(v => { v.classList.add('hidden'); v.classList.remove('active'); }); 
            if (viewId !== 'grid-wall') {
                const target = document.getElementById(viewId);
                target.classList.remove('hidden');
                setTimeout(() => target.classList.add('active'), 10);
            }
        }

        function requestAdminAccess() { const p = prompt("PIN:"); if (p === state.pin) openAdmin(); }
        function initAdminEntry() { let t; const h = document.getElementById('app-title'); h.addEventListener('mousedown', () => t = setTimeout(requestAdminAccess, 2000)); h.addEventListener('mouseup', () => clearTimeout(t)); h.addEventListener('touchstart', () => t = setTimeout(requestAdminAccess, 2000)); h.addEventListener('touchend', () => clearTimeout(t)); }

        function openAdmin() {
            const list = document.getElementById('admin-task-list'); list.innerHTML = '';
            document.getElementById('task-count-display').innerText = state.tasks.length;
            state.tasks.forEach((t, i) => {
                const d = document.createElement('div'); d.className = 'list-item'; d.innerHTML = `<span>${t.content}</span><button onclick="delTask(${i})" style="color:red; border:none; background:none;">åˆªé™¤</button>`;
                list.appendChild(d);
            });
            document.getElementById('admin-enc-textarea').value = (state.encouragements || initialEncs).join('\n');
            document.getElementById('admin-view').classList.remove('hidden');
            showView('admin-view');
        }

        function addAdminTask() {
            const c = document.getElementById('new-task-title').value.trim();
            const g = document.getElementById('new-task-guide').value.trim();
            if (!c) return; state.tasks.push({ id: "t"+Date.now(), content: c, guide: g });
            saveState(); openAdmin(); document.getElementById('new-task-title').value = ''; document.getElementById('new-task-guide').value = '';
        }

        function saveEncConfig() {
            const val = document.getElementById('admin-enc-textarea').value;
            state.encouragements = val.split('\n').filter(s => s.trim() !== "");
            saveState();
            alert("å·²å„²å­˜é¼“å‹µèªï¼");
            closeAdmin();
        }

        function delTask(i) { if(confirm("åˆªé™¤ï¼Ÿ")) { state.tasks.splice(i, 1); saveState(); openAdmin(); } }
        function closeAdmin() { document.getElementById('admin-view').classList.add('hidden'); showView('grid-wall'); renderGrid(); }
        function resetAllGrids() { if(confirm("é‡ç½®é€²åº¦ï¼Ÿ")) { for(let i=1; i<=40; i++) state.gridProgress[i] = false; state.sessionShownTaskIds = []; saveState(); location.reload(); } }
        function resetConfig() { if(confirm("é‚„åŸåŸå» ï¼Ÿ")) { localStorage.removeItem('poke_fun_adventure_v7'); location.reload(); } }
        init();
    </script>
</body>
</html>
