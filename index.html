<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æˆ³æˆ³æ¨‚å¤§å†’éšª - å…’ç«¥æ’ç³»çµ±</title>
    <style>
        :root {
            /* å†’éšªè‰²å½©ï¼šé¦¬å¡é¾è‰²ç³» */
            --color-blue: #E3F2FD;
            --color-green: #E8F5E9;
            --color-yellow: #FFF9C4;
            --color-orange: #FFE0B2;
            --color-purple: #F3E5F5;
            
            --bg-texture: #FDFBF7;
            --text-main: #5D544C;
            --text-light: #A8A096;
            --white: #FFFFFF;
            --accent: #FFAB91;
            
            /* é™°å½±è¨­è¨ˆ */
            --shadow-paper: 0 4px 8px rgba(93, 84, 76, 0.12);
            --shadow-sticker: 0 2px 0px rgba(0, 0, 0, 0.05);
            --shadow-lift: 0 10px 30px rgba(93, 84, 76, 0.2);
            --transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: "PingFang TC", "Microsoft JhengHei", "Rounded Mplus 1c", sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--bg-texture);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            background-image: 
                radial-gradient(circle at 10% 10%, rgba(167, 199, 231, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 90% 90%, rgba(255, 209, 220, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 50% 50%, #E8E1D9 1.5px, transparent 1.5px);
            background-size: 100% 100%, 100% 100%, 40px 40px;
        }

        /* æ¨™é¡Œå€åŸŸï¼šè‡ªå‹•ç¸®æ”¾å­—é«” */
        header {
            padding: 15px 10px 5px;
            text-align: center;
            flex-shrink: 0;
            position: relative;
        }

        h1 {
            font-size: clamp(1.8rem, 6vw, 3.2rem);
            color: #7D6E5D;
            letter-spacing: clamp(2px, 1vw, 6px);
            cursor: pointer;
            user-select: none;
            text-shadow: 2px 2px 0px rgba(255,255,255,0.9);
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.08));
        }

        /* ç®¡ç†æŒ‰éˆ•ï¼šæ‰‹æ©Ÿç‰ˆç¸®å° */
        .btn-settings-trigger {
            position: absolute;
            right: 15px;
            top: 15px;
            background: rgba(255,255,255,0.6);
            border: 2px solid white;
            width: clamp(35px, 8vw, 45px);
            height: clamp(35px, 8vw, 45px);
            border-radius: 50%;
            font-size: 1.1rem;
            color: var(--text-light);
            cursor: pointer;
            opacity: 0.5;
            transition: opacity 0.3s, transform 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            z-index: 10;
        }

        .btn-settings-trigger:hover { opacity: 1; transform: rotate(45deg); }

        /* æ ¼å­ç‰†è¦–åœ– (8x5)ï¼šé©é…è¡Œå‹•è£ç½® */
        .grid-container {
            flex-grow: 1;
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(5, 1fr);
            gap: clamp(5px, 1.5vw, 15px);
            padding: 10px clamp(10px, 4vw, 40px) 20px;
            max-width: 1500px;
            margin: 0 auto;
            width: 100%;
            transition: var(--transition);
        }

        /* æ‰‹æ©Ÿç›´å‘æ™‚èª¿æ•´æ ¼å­ï¼Œé¿å… 8 æ¬„å¤ªæ“  */
        @media (max-width: 600px) {
            .grid-container {
                grid-template-columns: repeat(5, 1fr);
                grid-template-rows: repeat(8, 1fr);
            }
        }

        body.task-active .grid-container {
            filter: grayscale(0.4) blur(1px) brightness(0.9);
            transform: scale(0.96);
            pointer-events: none;
        }

        /* å‹•ç•« */
        @keyframes character-bounce {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-3px) scale(1.03); }
        }

        @keyframes card-wave {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-1deg); }
            75% { transform: rotate(1deg); }
        }

        /* æ ¼å­å¡ç‰‡ */
        .poke-item {
            background: var(--white);
            border-radius: clamp(12px, 3vw, 24px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: var(--shadow-paper);
            cursor: pointer;
            transition: var(--transition);
            border: clamp(2px, 0.5vw, 5px) solid var(--white);
            position: relative;
            overflow: hidden;
            z-index: 1;
            aspect-ratio: 1 / 1; /* ä¿æŒæ­£æ–¹å½¢ */
        }

        .poke-item:hover {
            z-index: 10;
            box-shadow: var(--shadow-lift);
            animation: card-wave 0.8s ease-in-out infinite;
        }

        /* å¾ªç’°èƒŒæ™¯é…è‰² */
        .c-1 { background-color: var(--color-blue); }
        .c-2 { background-color: var(--color-green); }
        .c-3 { background-color: var(--color-yellow); }
        .c-4 { background-color: var(--color-orange); }
        .c-5 { background-color: var(--color-purple); }

        .poke-item.completed {
            background-color: #ECEAE7 !important;
            cursor: default;
            transform: none !important;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
            animation: none !important;
        }

        /* è™Ÿç¢¼è²¼ç´™ */
        .number-sticker {
            background: white;
            width: clamp(30px, 10vw, 54px);
            height: clamp(30px, 10vw, 54px);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(1rem, 4vw, 1.8rem);
            font-weight: 900;
            color: #7D6E5D;
            box-shadow: var(--shadow-sticker);
            border: clamp(2px, 0.5vw, 4px) solid white;
            z-index: 5;
            position: relative;
            transform: rotate(-4deg);
            margin-top: -10px;
        }

        /* è§’è‰²æ’åœ– */
        .char-icon {
            position: absolute;
            bottom: -5%;
            right: -5%;
            width: 70%;
            height: 70%;
            opacity: 0.6;
            z-index: 2;
            transition: var(--transition);
        }

        /* ä»»å‹™è¦–çª— */
        .view {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 100;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            text-align: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease;
        }

        .view.active { opacity: 1; pointer-events: auto; }

        #task-view { background: rgba(253, 251, 247, 0.95); }

        .card-task {
            background: white;
            padding: clamp(25px, 8vw, 60px);
            border-radius: clamp(20px, 5vw, 40px);
            box-shadow: 0 20px 60px rgba(93, 84, 76, 0.2);
            max-width: 90%;
            width: 100%;
            border: clamp(6px, 2vw, 12px) solid rgba(255,255,255,0.8);
            animation: popIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.25);
            position: relative;
        }

        .task-content {
            font-size: clamp(1.8rem, 8vw, 4.2rem);
            font-weight: 900;
            margin-bottom: clamp(20px, 5vw, 40px);
            line-height: 1.2;
            color: #4A443F;
        }

        .task-guide {
            font-size: clamp(1rem, 4vw, 1.6rem);
            color: #8D8276;
            margin-bottom: clamp(30px, 8vw, 60px);
            background: #F9F7F5;
            padding: 15px 25px;
            border-radius: 15px;
            display: inline-block;
            border-left: 6px solid var(--color-green);
        }

        /* æŒ‰éˆ•é¢¨æ ¼ */
        .button-group { 
            display: flex; 
            gap: 15px; 
            justify-content: center; 
            flex-wrap: wrap; 
        }

        .btn {
            padding: clamp(12px, 3vw, 22px) clamp(20px, 10vw, 70px);
            font-size: clamp(1.1rem, 4vw, 1.8rem);
            font-weight: bold;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 6px 15px rgba(0,0,0,0.1);
            width: auto;
            min-width: 140px;
        }

        /* ç®¡ç†æ¨¡å¼é©æ‡‰æ‰‹æ©Ÿ */
        .admin-view { background: #fff; padding: 20px; overflow-y: auto; text-align: left; }
        .admin-section { margin-bottom: 20px; }
        
        @media (max-width: 600px) {
            .btn { width: 100%; }
            .button-group { flex-direction: column; }
            .card-task { padding: 30px 20px; }
        }

        .check-mark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: clamp(2.5rem, 10vw, 4.5rem);
            color: rgba(93, 84, 76, 0.2);
            z-index: 0;
            font-weight: 900;
        }

        .svg-lib { display: none; }
    </style>
</head>
<body>

    <!-- SVG è§’è‰²æ’åœ–åº« -->
    <svg class="svg-lib">
        <symbol id="char-lamb-awake" viewBox="0 0 100 100">
            <circle cx="50" cy="50" r="42" fill="#F4F2EF" />
            <circle cx="35" cy="45" r="5" fill="#5D544C" />
            <circle cx="65" cy="45" r="5" fill="#5D544C" />
            <path d="M42 62 Q50 70 58 62" fill="none" stroke="#5D544C" stroke-width="4" stroke-linecap="round" />
            <ellipse cx="15" cy="40" rx="10" ry="14" fill="#F4F2EF" />
            <ellipse cx="85" cy="40" rx="10" ry="14" fill="#F4F2EF" />
        </symbol>
        <symbol id="char-lamb-sleep" viewBox="0 0 100 100">
            <circle cx="50" cy="50" r="42" fill="#E0DED9" />
            <path d="M30 45 Q35 50 40 45" fill="none" stroke="#A8A096" stroke-width="4" stroke-linecap="round" />
            <path d="M60 45 Q65 50 70 45" fill="none" stroke="#A8A096" stroke-width="4" stroke-linecap="round" />
        </symbol>
        <symbol id="char-star-awake" viewBox="0 0 100 100">
            <path d="M50 8 L63 38 L95 38 L70 58 L80 88 L50 72 L20 88 L30 58 L5 38 L37 38 Z" fill="#FFF9C4" />
            <circle cx="42" cy="48" r="3.5" fill="#5D544C" />
            <circle cx="58" cy="48" r="3.5" fill="#5D544C" />
        </symbol>
        <symbol id="char-star-sleep" viewBox="0 0 100 100">
            <path d="M50 8 L63 38 L95 38 L70 58 L80 88 L50 72 L20 88 L30 58 L5 38 L37 38 Z" fill="#E8E4E0" />
            <path d="M38 48 Q42 52 46 48" fill="none" stroke="#A8A096" stroke-width="3" />
            <path d="M54 48 Q58 52 62 48" fill="none" stroke="#A8A096" stroke-width="3" />
        </symbol>
        <symbol id="char-heart-awake" viewBox="0 0 100 100">
            <path d="M50 88 L43 81 C25 65 15 53 15 38 C15 25 25 15 38 15 C45 15 52 18 56 25 C60 18 67 15 74 15 C87 15 97 25 97 38 C97 53 87 65 69 81 Z" fill="#FFD1DC" />
            <circle cx="45" cy="40" r="4" fill="#5D544C" />
            <circle cx="67" cy="40" r="4" fill="#5D544C" />
        </symbol>
        <symbol id="char-heart-sleep" viewBox="0 0 100 100">
            <path d="M50 88 L43 81 C25 65 15 53 15 38 C15 25 25 15 38 15 C45 15 52 18 56 25 C60 18 67 15 74 15 C87 15 97 25 97 38 C97 53 87 65 69 81 Z" fill="#EAE8E5" />
            <path d="M40 40 Q45 45 50 40" fill="none" stroke="#A8A096" stroke-width="3" />
        </symbol>
        <symbol id="char-cloud-awake" viewBox="0 0 100 100">
            <path d="M25 60 C10 60 10 40 25 40 C25 20 45 20 50 35 C55 20 75 20 75 40 C90 40 90 60 75 60 Z" fill="#E3F2FD" />
            <circle cx="42" cy="45" r="3" fill="#5D544C" />
            <circle cx="58" cy="45" r="3" fill="#5D544C" />
        </symbol>
        <symbol id="char-cloud-sleep" viewBox="0 0 100 100">
            <path d="M25 60 C10 60 10 40 25 40 C25 20 45 20 50 35 C55 20 75 20 75 40 C90 40 90 60 75 60 Z" fill="#DCE1E6" />
            <path d="M38 45 Q42 48 46 45" fill="none" stroke="#A8A096" stroke-width="2" />
        </symbol>
    </svg>

    <header>
        <h1 id="app-title" title="é•·æŒ‰é€²å…¥è¨­å®š">ã€ˆæˆ³æˆ³æ¨‚å¤§å†’éšªã€‰</h1>
        <button class="btn-settings-trigger" onclick="requestAdminAccess()" title="é€²å…¥è¨­å®šä¸­å¿ƒ">âš™ï¸</button>
    </header>

    <div id="grid-wall" class="grid-container"></div>

    <div id="task-view" class="view">
        <div class="card-task">
            <div class="task-pre-title">âœ¨ å‹‡æ•¢çš„å†’éšªè€…ï¼Œé€™æ˜¯ä½ çš„å°ä»»å‹™ âœ¨</div>
            <div id="current-task-text" class="task-content">å°‹æ‰¾ä»»å‹™ä¸­...</div>
            <div id="current-task-guide" class="task-guide">è€å¸«æœƒå’Œä½ ä¸€èµ·å®Œæˆé€™å€‹æŒ‘æˆ°å–”ï¼</div>
            <div class="button-group">
                <button class="btn btn-secondary" onclick="cancelTask()">è¿”å›åœ°åœ–</button>
                <button class="btn btn-primary" id="finish-task-btn" onclick="finishTask()">æˆ‘å®Œæˆä»»å‹™äº† âœ“</button>
            </div>
        </div>
    </div>

    <div id="enc-view" class="view">
        <div class="card-task" style="border-color: #F3E5F5;">
            <div id="enc-text" class="task-content" style="color: #7D6E5D;">ä¸»å¾ˆå–œæ‚…ä½ çš„æ“ç·´ â¤ï¸</div>
            <div style="margin-top: 20px; font-size: 1.2rem; color: #A8A096;">[ ä»»å‹™é”æˆï¼æ­£åœ¨å›åˆ°å†’éšªç‰† ]</div>
        </div>
    </div>

    <div id="admin-view" class="view admin-view">
        <div style="max-width: 900px; width: 100%; margin: 0 auto; background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>å†’éšªä»»å‹™æ§åˆ¶å°</h2>
                <button onclick="closeAdmin()" class="btn btn-secondary" style="padding: 10px 20px; min-width: auto; font-size: 1rem;">è¿”å›éŠæˆ²</button>
            </div>

            <div class="admin-section">
                <label class="toggle-switch">
                    <input type="checkbox" id="audio-toggle" class="toggle-input" onchange="toggleAudio(this.checked)">
                    <div class="toggle-slider"></div>
                    <span id="audio-status-text">éŸ³æ•ˆå·²é–‹å•Ÿ</span>
                </label>
            </div>

            <div style="background: #FDFBF7; padding: 15px; border-radius: 15px; border: 2px dashed #E8E1D9;">
                <h3>ğŸ“œ æ–°å¢ä»»å‹™å¡</h3>
                <input type="text" id="new-task-title" placeholder="ä¸»è¦ä»»å‹™å…§å®¹ (å¤§å­—)" style="width: 100%; padding: 12px; margin: 10px 0; border-radius: 10px; border: 1px solid #ddd;">
                <input type="text" id="new-task-guide" placeholder="è€å¸«å¼•å°èªªæ˜ (å°å­—)" style="width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 10px; border: 1px solid #ddd;">
                <button onclick="addAdminTask()" class="btn btn-primary" style="padding: 10px; font-size: 1rem; width: 100%;">å¢åŠ åˆ°ä»»å‹™åº«</button>
            </div>

            <h3 style="margin: 15px 0 10px;">ğŸ“‹ ä»»å‹™ç¸½è¡¨ (<span id="task-count-display">0</span>)</h3>
            <div id="admin-task-list" style="max-height: 250px; overflow-y: auto; border: 1px solid #eee; border-radius: 10px; padding: 10px;"></div>

            <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                <button onclick="resetAllGrids()" class="btn btn-secondary" style="background:#FFAB91; color:white; min-width: auto; font-size: 0.9rem;">é‡ç½®åœ°åœ–é€²åº¦</button>
                <button onclick="resetConfig()" class="btn btn-secondary" style="min-width: auto; font-size: 0.9rem;">æ¢å¾©åŸå» è¨­å®š</button>
            </div>
        </div>
    </div>

    <script>
        let audioCtx = null;
        function initAudio() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
        function playSound(type) {
            if (!state.audioEnabled || !audioCtx) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const masterGain = audioCtx.createGain();
            masterGain.gain.setValueAtTime(0.2, audioCtx.currentTime);
            masterGain.connect(audioCtx.destination);
            switch(type) {
                case 'tap':
                    const oscTap = audioCtx.createOscillator();
                    const gainTap = audioCtx.createGain();
                    oscTap.type = 'sine';
                    oscTap.frequency.setValueAtTime(300, audioCtx.currentTime);
                    oscTap.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.1);
                    gainTap.gain.setValueAtTime(0.5, audioCtx.currentTime);
                    gainTap.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                    oscTap.connect(gainTap); gainTap.connect(masterGain);
                    oscTap.start(); oscTap.stop(audioCtx.currentTime + 0.1);
                    break;
                case 'shimmer':
                    [880, 1320].forEach((freq, i) => {
                        const osc = audioCtx.createOscillator();
                        const gain = audioCtx.createGain();
                        osc.type = 'sine'; osc.frequency.setValueAtTime(freq, audioCtx.currentTime + (i * 0.05));
                        gain.gain.setValueAtTime(0, audioCtx.currentTime + (i * 0.05));
                        gain.gain.linearRampToValueAtTime(0.3, audioCtx.currentTime + (i * 0.05) + 0.05);
                        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
                        osc.connect(gain); gain.connect(masterGain);
                        osc.start(audioCtx.currentTime + (i * 0.05)); osc.stop(audioCtx.currentTime + 0.6);
                    });
                    break;
                case 'success':
                    [523.25, 659.25, 783.99].forEach((freq, i) => {
                        const osc = audioCtx.createOscillator();
                        const gain = audioCtx.createGain();
                        osc.type = 'sine'; osc.frequency.setValueAtTime(freq, audioCtx.currentTime + (i * 0.15));
                        gain.gain.setValueAtTime(0, audioCtx.currentTime + (i * 0.15));
                        gain.gain.linearRampToValueAtTime(0.4, audioCtx.currentTime + (i * 0.15) + 0.05);
                        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + (i * 0.15) + 0.4);
                        osc.connect(gain); gain.connect(masterGain);
                        osc.start(audioCtx.currentTime + (i * 0.15)); osc.stop(audioCtx.currentTime + (i * 0.15) + 0.5);
                    });
                    break;
            }
        }

        const initialTasks = [
            { id: "t1", content: "å¤§è²èªªä¸€æ¬¡ã€Œä¸»è€¶ç©Œæˆ‘æ„›ä½ ã€", guide: "è€å¸«å¯ä»¥å¸¶é ˜å¤§å®¶ä¸€èµ·å›æ‡‰ä»–å–”" },
            { id: "t2", content: "æ‰¾ä¸€ä½å°æœ‹å‹æ“ŠæŒ High-five", guide: "æŠŠå–œæ¨‚åˆ†äº«çµ¦èº«é‚Šçš„æœ‹å‹" },
            { id: "t3", content: "éœ²å‡ºä¸€å€‹æœ€å¤§ã€æœ€æ£’çš„ç¬‘å®¹", guide: "å–œæ¨‚çš„å¿ƒä¹ƒæ˜¯è‰¯è—¥" },
            { id: "t4", content: "å­¸å°ç¾Šå’©å’©å« 3 è²", guide: "æˆ‘å€‘éƒ½æ˜¯ä¸»æ‰€æ„›è­·çš„å°ç¾Š" },
            { id: "t5", content: "å¤§è²å®£ä½ˆï¼šæˆ‘æ˜¯ç¥çš„å¥½å­©å­", guide: "è®“å¤§å®¶çœ‹è¦‹ç¥å®¶å°ç²¾å…µçš„ç²¾ç¥" },
            { id: "t6", content: "æ‰¾ä¸€ä½å°æœ‹å‹æ¡æ¡æ‰‹", guide: "å°ä»–èªªï¼šé¡˜ä¸»è€¶ç©Œç¥ç¦ä½ " },
            { id: "t7", content: "çµ¦è€å¸«ä¸€å€‹å¸¥æ°£çš„æ“ŠæŒ", guide: "è‚¯å®šå­©å­çš„å‹‡æ°£èˆ‡æ“ç·´" },
            { id: "t8", content: "é–‰ä¸Šçœ¼ç›å®‰éœå¿ƒéˆ 10 ç§’é˜", guide: "è€å¸«å€’æ•¸ï¼Œä¸€èµ·æ„Ÿå—ä¸»çš„å¹³å®‰" },
            { id: "t9", content: "å“¼å”±ä¸€å¥ä½ æœ€å–œæ­¡çš„è©©æ­Œ", guide: "è€å¸«å¯ä»¥å…ˆå¹«å­©å­èµ·å€‹é ­" },
            { id: "t10", content: "èƒŒèª¦ï¼šç¥å°±æ˜¯æ„›", guide: "ç´„ç¿°ä¸€æ›¸å››ç«  8 ç¯€" },
            { id: "t11", content: "èªªå‡ºä¸€ä»¶æ„Ÿè¬ä¸»çš„äº‹æƒ…", guide: "åŸ¹è‚²å‡¡äº‹è¬æ©çš„å¥½å“æ ¼" },
            { id: "t12", content: "å°æ—é‚Šæœ‹å‹èªªã€Œä¸»æ„›ä½ ã€", guide: "åœ¨ä¸»è£¡å½¼æ­¤ç›¸æ„›" },
            { id: "t13", content: "å¹«å¿™æŠŠå¤§å®¶çš„æ¤…å­æ’æ•´é½Š", guide: "æ“ç·´æˆç‚ºç¥å®¶å¿ ä¿¡çš„å°ç®¡å®¶" },
            { id: "t14", content: "å¤§è²å‘¼æ±‚ï¼šå–”ï¼Œä¸»è€¶ç©Œï¼", guide: "æœ€ç°¡å–®ä¹Ÿæœ€æœ‰èƒ½åŠ›çš„ç”Ÿå‘½æ“ç·´" },
            { id: "t15", content: "åšå‡ºä¸€å€‹å¼·å£¯çš„ç²¾å…µå‹•ä½œ", guide: "åœ¨åŸºç£è£¡å‰›å¼·å£¯è†½" }
        ];
        const initialEncs = [ "é˜¿å€‘ï¼ä¸»å¾ˆå–œæ‚…ä½  â¤ï¸", "åšå¾—å¤ªæ£’äº†ï¼Œä½ å¾ˆå¯¶è²´ï¼", "ä¸»è€¶ç©Œçœ‹è¦‹ä½ çš„æ“ç·´äº†ï¼ŒåŠ æ²¹ï¼", "ä½ æ˜¯æœ€å‹‡æ•¢çš„å°ç²¾å…µï¼", "å“ˆåˆ©è·¯äºï¼ä¸»æ°¸é èˆ‡ä½ åŒåœ¨ã€‚", "ä½ å¸¶çµ¦å¤§å®¶è¨±å¤šå–œæ¨‚èˆ‡é¼“å‹µï¼", "ä¸»æ„›ä½ ï¼Œæˆ‘å€‘å¤§å®¶ä¹Ÿéƒ½æ„›ä½ ï¼" ];

        let state = { tasks: [], encouragements: [], gridProgress: {}, sessionShownTaskIds: [], audioEnabled: true, pin: "1234" };
        let currentActiveIndex = -1;
        const iconTypes = ['lamb', 'star', 'heart', 'cloud'];

        function init() {
            const savedState = localStorage.getItem('poke_fun_adventure_v5');
            if (savedState) {
                state = JSON.parse(savedState);
                if(!state.sessionShownTaskIds) state.sessionShownTaskIds = [];
            } else {
                state.tasks = JSON.parse(JSON.stringify(initialTasks)); state.encouragements = initialEncs;
                for(let i=1; i<=40; i++) state.gridProgress[i] = false;
                saveState();
            }
            const audioToggle = document.getElementById('audio-toggle');
            if(audioToggle) {
                audioToggle.checked = state.audioEnabled;
                document.getElementById('audio-status-text').innerText = state.audioEnabled ? "éŸ³æ•ˆå·²é–‹å•Ÿ" : "éŸ³æ•ˆå·²é—œé–‰";
            }
            renderGrid(); initAdminEntry();
        }

        function saveState() { localStorage.setItem('poke_fun_adventure_v5', JSON.stringify(state)); }
        function toggleAudio(enabled) { initAudio(); state.audioEnabled = enabled; document.getElementById('audio-status-text').innerText = enabled ? "éŸ³æ•ˆå·²é–‹å•Ÿ" : "éŸ³æ•ˆå·²é—œé–‰"; saveState(); }

        function renderGrid() {
            const container = document.getElementById('grid-wall'); container.innerHTML = '';
            for (let i = 1; i <= 40; i++) {
                const item = document.createElement('div');
                const isCompleted = state.gridProgress[i];
                const colorIdx = ((i - 1) % 5) + 1;
                const charType = iconTypes[(i - 1) % iconTypes.length];
                const charState = isCompleted ? 'sleep' : 'awake';
                item.className = `poke-item c-${colorIdx} ${isCompleted ? 'completed' : ''}`;
                const numStr = i < 10 ? '0' + i : i;
                item.innerHTML = `<div class="number-sticker">${numStr}</div><svg class="char-icon"><use xlink:href="#char-${charType}-${charState}"></use></svg>${isCompleted ? '<div class="check-mark">âœ“</div>' : ''}`;
                item.onclick = () => handleGridClick(i, item);
                container.appendChild(item);
            }
        }

        function handleGridClick(index, element) {
            if (state.gridProgress[index]) return;
            initAudio(); playSound('tap');
            document.body.classList.add('task-active');
            element.style.transform = "scale(1.2) translateY(-20px)";
            element.style.boxShadow = "var(--shadow-lift)";
            element.style.zIndex = "200";
            setTimeout(() => {
                currentActiveIndex = index;
                let availableTasks = state.tasks.filter(t => !state.sessionShownTaskIds.includes(t.id));
                if (availableTasks.length === 0) { state.sessionShownTaskIds = []; availableTasks = state.tasks; }
                const randomIndex = Math.floor(Math.random() * availableTasks.length);
                const selectedTask = availableTasks[randomIndex];
                state.sessionShownTaskIds.push(selectedTask.id); saveState();
                document.getElementById('current-task-text').innerText = selectedTask.content;
                document.getElementById('current-task-guide').innerText = selectedTask.guide || "è€å¸«æœƒé™ªè‘—ä½ ä¸€èµ·æ“ç·´å–”ï¼";
                showView('task-view'); playSound('shimmer');
            }, 400);
        }

        function finishTask() {
            playSound('success');
            const randomEnc = state.encouragements[Math.floor(Math.random() * state.encouragements.length)];
            document.getElementById('enc-text').innerText = randomEnc;
            showView('enc-view'); state.gridProgress[currentActiveIndex] = true; saveState();
            setTimeout(() => { document.body.classList.remove('task-active'); showView('grid-wall'); renderGrid(); }, 2500);
        }

        function cancelTask() { state.sessionShownTaskIds.pop(); saveState(); document.body.classList.remove('task-active'); showView('grid-wall'); renderGrid(); currentActiveIndex = -1; }
        function showView(viewId) { document.querySelectorAll('.view').forEach(v => v.classList.remove('active')); if (viewId !== 'grid-wall') document.getElementById(viewId).classList.add('active'); }

        function requestAdminAccess() { const pass = prompt("è«‹è¼¸å…¥ç®¡ç†è€… PIN ç¢¼ï¼š"); if (pass === state.pin) openAdmin(); else if (pass !== null) alert("å¯†ç¢¼ä¸æ­£ç¢ºå–”ï¼"); }
        function initAdminEntry() {
            let timer; const title = document.getElementById('app-title');
            const handleStart = () => { timer = setTimeout(() => { requestAdminAccess(); }, 2000)};
            const handleEnd = () => clearTimeout(timer);
            title.addEventListener('mousedown', handleStart); title.addEventListener('mouseup', handleEnd);
            title.addEventListener('touchstart', handleStart); title.addEventListener('touchend', handleEnd);
        }

        function openAdmin() {
            const list = document.getElementById('admin-task-list'); list.innerHTML = '';
            document.getElementById('task-count-display').innerText = state.tasks.length;
            state.tasks.forEach((t, idx) => {
                const div = document.createElement('div'); div.style.padding = "10px"; div.style.borderBottom = "1px solid #f0f0f0"; div.style.display = "flex"; div.style.justifyContent = "space-between"; div.style.alignItems = "center";
                div.innerHTML = `<div style="flex-grow: 1;"><div style="font-weight:bold;">${t.content}</div></div><button onclick="deleteAdminTask(${idx})" style="color:#FF6B6B; border:none; background:none; cursor:pointer;">åˆªé™¤</button>`;
                list.appendChild(div);
            });
            showView('admin-view');
        }

        function addAdminTask() {
            const content = document.getElementById('new-task-title').value.trim();
            const guide = document.getElementById('new-task-guide').value.trim();
            if (!content) return alert("è«‹å¡«å¯«ä»»å‹™å¤§å­—å…§å®¹");
            state.tasks.push({ id: "adv-" + Date.now(), content, guide });
            saveState(); openAdmin();
            document.getElementById('new-task-title').value = ''; document.getElementById('new-task-guide').value = '';
        }
        function deleteAdminTask(idx) { if(confirm("ç¢ºå®šè¦åˆªé™¤é€™å¼µå†’éšªå¡å—ï¼Ÿ")) { state.tasks.splice(idx, 1); saveState(); openAdmin(); } }
        function closeAdmin() { showView('grid-wall'); renderGrid(); }
        function resetAllGrids() { if(confirm("é‡ç½®ç´€éŒ„ï¼Ÿ")) { for(let i=1; i<=40; i++) state.gridProgress[i] = false; state.sessionShownTaskIds = []; saveState(); location.reload(); } }
        function resetConfig() { if(confirm("é‚„åŸåŸå» ï¼Ÿ")) { localStorage.removeItem('poke_fun_adventure_v5'); location.reload(); } }
        init();
    </script>
</body>
</html>
